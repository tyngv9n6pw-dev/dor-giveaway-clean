<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Draw | Dallas Off-Road Giveaway</title>
  <meta name="description" content="Live drawing tool for the Dallas Off-Road giveaway." />
  <style>
    :root{
      --bg:#07080b; --card:#0e1117; --muted:#a6aab6; --text:#f3f4f6;
      --accent:#ff2b2b; --accent2:#ffb020; --border:rgba(255,255,255,.10);
      --shadow:0 18px 60px rgba(0,0,0,.55); --glow:0 0 28px rgba(255,43,43,.22);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(900px 520px at 15% 0%, rgba(255,43,43,.22), transparent 60%),radial-gradient(900px 520px at 90% 10%, rgba(255,176,32,.12), transparent 55%),linear-gradient(180deg,#06070a 0%,#0a0c12 100%);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1050px;margin:0 auto;padding:26px 18px 70px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:13px}
    .card{margin-top:14px;background:rgba(14,17,23,.78);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .pad{padding:22px}
    h1{margin:0 0 8px;font-size:30px;letter-spacing:.3px;text-transform:uppercase}
    .sub{margin:0 0 16px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .mini{padding:16px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
    label{font-size:13px;color:var(--muted)}
    input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.35);color:var(--text);font-size:16px;outline:none}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.04);text-decoration:none;font-weight:800;letter-spacing:.3px;transition:transform .12s ease,filter .12s ease;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, rgba(255,43,43,.98), rgba(255,43,43,.55));border-color:rgba(255,43,43,.38);color:#0b0c10;box-shadow:var(--glow)}
    .btn.secondary{background:linear-gradient(135deg, rgba(255,176,32,.92), rgba(255,176,32,.40));border-color:rgba(255,176,32,.35);color:#0b0c10}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.06)}

    .wheelWrap{display:flex;align-items:center;justify-content:center;padding:22px}
    .wheel{
      width:320px;height:320px;border-radius:50%;border:2px solid rgba(255,255,255,.14);
      background:conic-gradient(from 0deg, rgba(255,43,43,.95), rgba(255,176,32,.85), rgba(255,43,43,.95));
      box-shadow:var(--shadow), var(--glow);
      position:relative; overflow:hidden;
      transform: rotate(0deg);
    }
    .wheel:before{
      content:""; position:absolute; inset:10px; border-radius:50%;
      background:radial-gradient(circle at 30% 25%, rgba(255,255,255,.16), transparent 55%), rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
    }
    .hub{position:absolute;inset:0;display:grid;place-items:center;font-weight:900;letter-spacing:.5px;text-transform:uppercase}
    .hub span{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.35)}
    .pointer{width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:26px solid rgba(255,43,43,.95);filter:drop-shadow(0 10px 20px rgba(0,0,0,.55));margin:0 auto}

    .result{margin-top:12px;padding:14px 14px;border-radius:14px;background:rgba(255,43,43,.10);border:1px solid rgba(255,43,43,.22);font-weight:850}
    .muted{color:var(--muted);font-size:13px;margin-top:8px;line-height:1.4}

    @media (max-width:900px){.row{grid-template-columns:1fr}.wheel{width:280px;height:280px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="pill"><b>Dallas Off-Road</b> ‚Ä¢ Live Drawing Tool</div>
      </div>
      <div class="pill" id="pill">Loading settings‚Ä¶</div>
      <div class="pill"><a href="/">‚Üê Back to landing page</a></div>
    </div>

    <div class="card">
      <div class="pad">
        <h1>Live Draw</h1>
        <p class="sub">This tool pulls the current entry list and picks a winner using public randomness (drand) + a recorded spin.</p>

        <div class="row">
          <div class="mini">
            <div class="pointer" aria-hidden="true"></div>
            <div class="wheelWrap">
              <div class="wheel" id="wheel"><div class="hub"><span>SPIN ‚Ä¢ PICK ‚Ä¢ WIN</span></div></div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
              <button class="btn primary" id="spinBtn">SPIN & DRAW</button>
              <button class="btn" id="refreshBtn">Refresh entries</button>
            </div>

            <div class="result" id="resultBox" style="display:none"></div>
            <div class="muted" id="audit" style="display:none"></div>
          </div>

          <div class="mini">
            <h2 style="margin:0 0 10px;font-size:18px">Draw Inputs</h2>
            <div style="display:flex;flex-direction:column;gap:10px">
              <div>
                <label>Total entries</label>
                <input id="totalEntries" readonly />
              </div>
              <div>
                <label>drand randomness round (auto)</label>
                <input id="drandRound" readonly />
              </div>
              <div>
                <label>drand randomness (hex)</label>
                <input id="drandHex" readonly />
              </div>
              <div>
                <label>Winner entry # (1..N)</label>
                <input id="winnerNumber" readonly />
              </div>
              <div class="muted">
                Verifiable randomness source: <a href="https://drand.love" target="_blank" rel="noopener">drand</a>. We compute: <b>index = (hex ‚Üí bigInt) mod N</b>.
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="pad">
        <h2 style="margin:0 0 10px;font-size:18px">Entry List Snapshot</h2>
        <p class="sub" style="margin:0 0 10px">For privacy, this shows invoice + initials only.</p>
        <div class="mini" id="entryPreview">Loading‚Ä¶</div>
      </div>
    </div>

  </div>

  <script>
    let ENTRY = null; // { totalEntries, segments: [{start,end,label,invoice,amount}] }

    async function loadAll(){
      const [statsRes, entriesRes] = await Promise.all([
        fetch('/api/stats', {cache:'no-store'}),
        fetch('/api/entries', {cache:'no-store'})
      ]);
      const stats = await statsRes.json();
      ENTRY = await entriesRes.json();

      document.getElementById('pill').textContent = `${stats.settings.prizeName} ‚Ä¢ Draw: ${stats.settings.drawDateText}`;
      document.getElementById('totalEntries').value = (ENTRY.totalEntries || 0).toLocaleString();

      const preview = (ENTRY.segments||[]).slice(0, 30)
        .map(s => `#${s.start}‚Äì${s.end} ‚Ä¢ ${s.label} ‚Ä¢ Inv ${s.invoice} ‚Ä¢ $${Math.floor(s.amount)} (${(s.end-s.start+1).toLocaleString()} entries)`).join('<br/>');
      document.getElementById('entryPreview').innerHTML = preview || 'No entries yet.';
    }

    function hexToBigInt(hex){
      const clean = hex.startsWith('0x') ? hex.slice(2) : hex;
      return BigInt('0x' + clean);
    }

    async function getDrand(){
      // Use public API from client-side. Latest is fine; we store round+randomness used.
      const r = await fetch('https://api.drand.sh/public/latest');
      const j = await r.json();
      return { round: j.round, randomness: j.randomness };
    }

    async function spinAndDraw(){
      if (!ENTRY) await loadAll();
      const N = Number(ENTRY.totalEntries || 0);
      if (!N || N <= 0){
        alert('No entries available yet. Upload invoices first.');
        return;
      }

      const { round, randomness } = await getDrand();
      document.getElementById('drandRound').value = String(round);
      document.getElementById('drandHex').value = randomness;

      const idx0 = Number(hexToBigInt(randomness) % BigInt(N)); // 0..N-1
      const winnerNum = idx0 + 1; // 1..N
      document.getElementById('winnerNumber').value = winnerNum.toLocaleString();

      // Spin animation (deterministic based on winnerNum)
      const wheel = document.getElementById('wheel');
      const spins = 8 + (winnerNum % 7);
      const deg = spins * 360 + (idx0 / N) * 360;
      wheel.style.transition = 'transform 3.4s cubic-bezier(.12,.85,.18,1)';
      wheel.style.transform = `rotate(${deg}deg)`;

      setTimeout(() => {
        const w = (ENTRY.segments||[]).find(s => winnerNum >= s.start && winnerNum <= s.end) || null;
        const box = document.getElementById('resultBox');
        const audit = document.getElementById('audit');
        box.style.display = 'block';
        audit.style.display = 'block';
        if (w){
          box.innerHTML = `üèÅ WINNER: <b>${w.label}</b> ‚Ä¢ Entry #<b>${winnerNum.toLocaleString()}</b> ‚Ä¢ Invoice <b>${w.invoice}</b> <span style="color:var(--muted);font-weight:700">(range #${w.start}‚Äì${w.end})</span>`;
        } else {
          box.innerHTML = `üèÅ WINNER ENTRY #: <b>${winnerNum.toLocaleString()}</b> (no matching entry record found)`;
        }
        audit.innerHTML = `Audit: drand round <b>${round}</b> ‚Ä¢ randomness <code>${randomness}</code> ‚Ä¢ formula: (randomness as bigInt % N)+1 where N=${N.toLocaleString()}.
        <br/>Tip: record this screen + keep the entry snapshot for the livestream.`;
      }, 3450);
    }

    document.getElementById('spinBtn').addEventListener('click', () => spinAndDraw().catch(e => {console.error(e);alert('Draw failed. Check console.');}));
    document.getElementById('refreshBtn').addEventListener('click', () => loadAll().catch(e => {console.error(e);alert('Refresh failed.');}));

    loadAll().catch(e => { console.error(e); document.getElementById('entryPreview').textContent = 'Failed to load entries. Upload invoices in Admin.'; });
  </script>
</body>
</html>
